app-id: com.voyc.app
runtime: org.gnome.Platform
runtime-version: '46'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node20
command: voyc

finish-args:
  # Display - Wayland native
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc

  # Audio capture via PipeWire
  - --socket=pipewire

  # Network access for ElevenLabs/OpenAI API calls
  - --share=network

  # System tray (StatusNotifierItem/SNI protocol)
  - --talk-name=org.kde.StatusNotifierWatcher

  # Global shortcuts via freedesktop portal
  - --talk-name=org.freedesktop.portal.GlobalShortcuts
  - --talk-name=org.freedesktop.portal.Desktop

  # DBus session bus access for notifications and portals
  - --socket=session-bus

  # User config directory for storing API keys and preferences
  - --filesystem=xdg-config/voyc:create

  # Clipboard access for text injection
  - --talk-name=org.freedesktop.portal.Clipboard

  # GSettings for GNOME integration
  - --talk-name=ca.desrt.dconf
  - --env=DCONF_USER_CONFIG_DIR=.config/dconf

build-options:
  append-path: /usr/lib/sdk/node20/bin
  env:
    NPM_CONFIG_LOGLEVEL: info

modules:
  # GJS type definitions and app build
  - name: voyc
    buildsystem: simple
    build-options:
      env:
        npm_config_cache: /run/build/voyc/npm-cache
        npm_config_offline: 'false'
    build-commands:
      # Install npm dependencies
      - npm ci --omit=dev --omit=optional

      # Build TypeScript to JavaScript
      - npm run build

      # Install application files to share directory
      - mkdir -p /app/share/voyc
      - cp -r dist/* /app/share/voyc/

      # Create launcher script that invokes GJS with correct path
      - |
        mkdir -p /app/bin
        cat > /app/bin/voyc << 'LAUNCHER_EOF'
        #!/bin/bash
        exec gjs -m /app/share/voyc/main.js "$@"
        LAUNCHER_EOF
        chmod +x /app/bin/voyc

      # Install desktop file
      - install -Dm644 com.voyc.app.desktop /app/share/applications/com.voyc.app.desktop

      # Install AppStream metadata
      - install -Dm644 com.voyc.app.metainfo.xml /app/share/metainfo/com.voyc.app.metainfo.xml

      # Install icon (microphone icon in GNOME blue)
      - mkdir -p /app/share/icons/hicolor/scalable/apps
      - |
        cat > /app/share/icons/hicolor/scalable/apps/com.voyc.app.svg << 'ICON_EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 128 128">
          <circle cx="64" cy="64" r="56" fill="#3584e4" stroke="#1a5fb4" stroke-width="4"/>
          <path d="M64 28c-8.8 0-16 7.2-16 16v24c0 8.8 7.2 16 16 16s16-7.2 16-16V44c0-8.8-7.2-16-16-16z" fill="white"/>
          <path d="M88 68c0 13.3-10.7 24-24 24s-24-10.7-24-24h-8c0 16.5 12.1 30.1 28 32.5V108h8V100.5c15.9-2.4 28-16 28-32.5h-8z" fill="white"/>
        </svg>
        ICON_EOF

    sources:
      - type: dir
        path: .

      # Desktop file for Flatpak
      - type: file
        path: com.voyc.app.desktop

      # AppStream metadata
      - type: file
        path: com.voyc.app.metainfo.xml
